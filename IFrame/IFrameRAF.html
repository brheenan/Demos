<!DOCTYPE html>
<html>
<head>
    <script>
        // This is the iframe used to testing RAF's within iframes, both x-domain and same domain.
        // The iframe has one main job, to request animation frames and count how many
        // callbacks for request animation frames it's recieved.
        //
        // The host of the iframe will use post mesages to query the current RAF count to determine
        // if we've processed RAFs as expected.
        'use strict';
        
        var rafCount = 0;
        var stopRAF = false;
        var mostRecentDelays = [];
        var delaysIndex = 0;
        var secondsToKeep = 5;
        var delaysToKeep = secondsToKeep * 60;
        var firstRAFTime = 0;

        function RAFCallback() {
            var currentDate = new Date();
            var output1 = document.getElementById("output1");

            var delay = currentDate.getTime() - lastCallback.getTime();
            if (delay >= 1000) {
                output1.innerHTML += "DELAY: " + delay + "!!!!!!!\n";
            }

            if (firstRAFTime == 0) {
                firstRAFTime = currentDate.getTime() - lastCallback.getTime();
                output2.innerHTML = "First RAF time: " + firstRAFTime;
            }

            lastCallback = currentDate;

			mostRecentDelays[delaysIndex] = delay;
			delaysIndex = (delaysIndex + 1) % delaysToKeep;
			var biggestRecentDelay = Math.max.apply(null, mostRecentDelays);
			output1.innerHTML = "Biggest recent RAF delay in last " + secondsToKeep + "s: " + biggestRecentDelay;
            rafCount++;

            if (!stopRAF) {
                window.requestAnimationFrame(RAFCallback);
            }
        }

        var lastCallback = new Date();
        window.requestAnimationFrame(RAFCallback);

        function receiveMessage(event) {
            if (event.data.getRAFCount) {
                event.source.postMessage({ RAFCount: rafCount, RAFCountMsg: true }, "*");
            }
            else if (event.data.stopRAF) {
                stopRAF = true;
            }
        }

        window.addEventListener("message", receiveMessage);
    </script>
</head>
<body>
    <div>
        <div id="output1" style="border: 1px solid black; padding: 10px; overflow: hidden; white-space: pre; display: inline-block"></div>
        <div id="output2" style="border: 1px solid green; padding: 10px; overflow: hidden; white-space: pre; display: inline-block"></div>
    </div>
</body>
</html>
